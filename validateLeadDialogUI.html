<!-- Example: Validate Lead Dialog as HTML/CSS/JS -->
<!-- In this version 3, 
  1. I will handle the population of account name without hyper link for new account  -- done
  2. Radio button should be disabled if exising account is false -- done
  3. Account drop down should not be there if existing account is false -- done
  4. In case of new account, customer group id options drop down should be there -- done
  5. In case of existing account only, make the account field as hyper link, so that user can navigate to the account by clicking on the hyper link of account. By clicking on the link a new tab should open of the account -- needs to fix the issue
  6. In case of existing account, customer grp id should be auto populate based on selection or change of account, for this fetch the detail of selected account in dialog form and populate the customer grp id
  7. Account Type, and Customer grp id is not saving in lead, it should be save -- Needs to fix for customer group id
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Validate Lead Dialog</title>
    <!-- <style>
        /* Basic dialog styles */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            /* nk  */
            /* background: rgba(0, 0, 0, 0.45);
            animation: fadeIn 0.3s ease-in-out; */
        }

        .dialog-box {
            background: #fff;
            border-radius: 12px;
            width: 500px;
            max-width: 90vw;
            padding: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);

            /* NK  */
            /* box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            font-family: "Segoe UI", Roboto, sans-serif;
            animation: slideUp 0.35s ease-out; */
        }

        .dialog-title {
            font-size: 1.5em;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;

            /* NK  */
            /* color: #222222 */
        }

        /* =========================================================
    * Form Layout (now scrollable) - NK
    * ======================================================= */
        #leadForm {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px 24px;
            /* row gap x column gap */

            /* Form scrollbar: choose one of the height strategies below */
            max-height: 55vh;
            /* responsive to viewport height */
            /* max-height: 420px;   /* or use a fixed max-height if preferred */

            overflow-y: auto;
            /* enable vertical scrolling when needed */
            overflow-x: hidden;
            /* prevent horizontal scrollbars */
            scrollbar-gutter: stable both-edges;
            /* reduce layout shift when scrollbars appear */
        }

        .dialog-actions {
            margin-top: 24px;
            text-align: right;
        }

        .dialog-actions button {
            margin-left: 8px;
            padding: 8px 16px;
            font-size: 1em;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            font-size: 1em;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .error {
            color: #d32f2f;
            font-size: 0.9em;
            margin-top: 4px;
        }

        .loading {
            text-align: center;
            padding: 32px 0;
        }
    </style> -->

    <style>
        /* =========================================================
    * Overlay
    * ======================================================= */
        .dialog-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.45);
            animation: fadeIn 0.3s ease-in-out;
        }

        /* =========================================================
    * Dialog Box
    * ======================================================= */
        .dialog-box {
            width: 100%;
            /* height: 100%; */
            max-width: 60%;
            /* max-height: 50%; */
            padding: 28px 32px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            font-family: "Segoe UI", Roboto, sans-serif;
            animation: slideUp 0.35s ease-out;
        }

        /* =========================================================
    * Title
    * ======================================================= */
        .dialog-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 10px;
            color: #222222;
            font-size: 1.5em;
            font-weight: 600;
            border-bottom: 1px solid #eeeeee;
        }

        /* =========================================================
    * Form Layout (now scrollable)
    * ======================================================= */
        #leadForm {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px 24px;
            /* row gap x column gap */

            /* Form scrollbar: choose one of the height strategies below */
            max-height: 55vh;
            /* responsive to viewport height */
            /* max-height: 420px;   /* or use a fixed max-height if preferred */

            overflow-y: auto;
            /* enable vertical scrolling when needed */
            overflow-x: hidden;
            /* prevent horizontal scrollbars */
            scrollbar-gutter: stable both-edges;
            /* reduce layout shift when scrollbars appear */
        }

        /* Action bar spans full width at the bottom of the scrollable grid */
        .dialog-actions {
            grid-column: span 2;
            margin-top: 8px;
            text-align: right;
            margin-right: 20px;
        }

        /* =========================================================
    * Form Controls
    * ======================================================= */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-right: 20px;
        }

        .form-group label {
            margin-bottom: 6px;
            color: #444444;
            font-size: 0.92em;
            font-weight: 600;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px 14px;
            color: #222222;
            font-size: 0.95em;
            background: #fafafa;
            border: 1px solid #cccccc;
            border-radius: 8px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            background: #ffffff;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2);
        }

        /* =========================================================
    * Custom Select Arrow (single icon, no tiling)
    * ======================================================= */
        .form-group select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;

            background-image:
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%23999' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 14px 14px;

            padding-right: 40px;
            /* space for arrow */
        }

        .form-group select:focus {
            background-image:
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%231976d2' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 14px 14px;
        }

        /* =========================================================
    * Option Styling (best-effort; native rendering varies)
    * ======================================================= */
        .form-group select option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            /* may be ignored by some UAs */
        }

        .form-group select option:hover {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .form-group select option:checked {
            background-color: #1976d2;
            color: #ffffff;
        }

        /* Account Status Radios + Account Field Layout  */
        .full-width {
            grid-column: span 2;
        }

        .radio-group {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .radio-group .radio-option {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            color: #444444;
        }

        /* =========================================================
    * Errors
    * ======================================================= */
        .error {
            margin-top: 4px;
            color: #d32f2f;
            font-size: 0.8em;
            font-style: italic;
        }

        /* =========================================================
    * Actions (Buttons)
    * ======================================================= */
        .dialog-actions button {
            padding: 10px 20px;
            margin-left: 10px;
            margin-top: 10px;
            color: #222222;
            font-size: 0.95em;
            background: #f1f1f1;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.25s ease, transform 0.15s ease-in-out;
        }

        .dialog-actions button:last-child {
            color: #444444;
            background: #f1f1f1;
        }

        .dialog-actions button:last-child:hover {
            background: #e0e0e0;
        }

        .dialog-actions button:first-child {
            color: #ffffff;
            background: #1976d2;
            font-weight: 500;
        }

        .dialog-actions button:first-child:hover {
            background: #1565c0;
            transform: translateY(-2px);
        }

        /* =========================================================
    * Loading
    * ======================================================= */
        .loading {
            grid-column: span 2;
            padding: 40px 0;
            color: #666666;
            font-size: 1em;
            font-weight: 500;
            text-align: center;
        }

        /* =========================================================
    * Scrollbars (Form + Selects)
    * ======================================================= */
        /* Form scrollbar (Firefox) */
        #leadForm {
            scrollbar-width: thin;
            scrollbar-color: #b0b0b0 #f0f0f0;
            /* thumb track */
        }

        /* Form scrollbar (WebKit) */
        #leadForm::-webkit-scrollbar {
            width: 10px;
        }

        #leadForm::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 8px;
        }

        #leadForm::-webkit-scrollbar-thumb {
            background: #b0b0b0;
            border-radius: 8px;
        }

        #leadForm::-webkit-scrollbar-thumb:hover {
            background: #888888;
        }

        /* Select dropdown scrollbars (already styled) */
        select {
            scrollbar-width: thin;
            scrollbar-color: #b0b0b0 #f0f0f0;
        }

        select::-webkit-scrollbar {
            width: 8px;
        }

        select::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 8px;
        }

        select::-webkit-scrollbar-thumb {
            background: #b0b0b0;
            border-radius: 8px;
        }

        select::-webkit-scrollbar-thumb:hover {
            background: #888888;
        }

        /* =========================================================
    * Animations
    * ======================================================= */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(35px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="validateLeadDialog" class="dialog-overlay" style="display:none;">
        <div class="dialog-box">
            <div class="dialog-title">
                <span>Validate Lead</span>
            </div>
            <div id="dialogContent">
                <div class="loading" id="loadingSpinner">Loading...</div>
                <form id="leadForm" style="display:none;" autocomplete="off" novalidate>
                    <div class="form-group">
                        <label for="legalEntity">Legal Entity</label>
                        <select id="legalEntity"></select>
                        <div class="error" id="errorLegalEntity"></div>
                    </div>
                    <div class="form-group full-width">
                        <label>Account Status</label>
                        <div class="radio-group" role="radiogroup" aria-label="Account Status">
                            <label class="radio-option" for="accountStatusActive">
                                <input type="radio" id="accountStatusActive" name="accountStatus" value="active">
                                Active
                            </label>
                            <label class="radio-option" for="accountStatusInactive">
                                <input type="radio" id="accountStatusInactive" name="accountStatus" value="inactive">
                                Inactive
                            </label>
                        </div>
                        <div class="error" id="errorAccountStatus"></div>
                    </div>
                    <div class="form-group full-width">
                        <label for="account">Account</label>
                        <select id="account"></select>
                        <div id="accountLinkContainer" style="display:none;margin-top:6px;">
                            <a id="accountLink" href="#" target="_blank" rel="noopener">Open Account</a>
                        </div>
                        <div class="error" id="errorAccount"></div>
                    </div>
                    <div class="form-group">
                        <label for="contractingUnit">Contracting Unit</label>
                        <select id="contractingUnit"></select>
                        <div class="error" id="errorContractingUnit"></div>
                    </div>
                    <div class="form-group">
                        <label for="marketSegment">Market Segment</label>
                        <select id="marketSegment"></select>
                        <div class="error" id="errorMarketSegment"></div>
                    </div>
                    <div class="form-group">
                        <label for="industry">Industry</label>
                        <select id="industry"></select>
                        <div class="error" id="errorIndustry"></div>
                    </div>
                    <div class="form-group">
                        <label for="customerGroupId">Customer Group</label>
                        <select id="customerGroupId"></select>
                        <div class="error" id="errorCustomerGroupId"></div>
                    </div>
                    <div class="form-group">
                        <label for="accountType">Account Type</label>
                        <select id="accountType"></select>
                        <div class="error" id="errorAccountType"></div>
                    </div>

                    <div class="dialog-actions">
                        <button type="button" onclick="submitForm()">Submit</button>
                        <button type="button" onclick="closeDialog()">Cancel</button>
                    </div>
                    <div class="error" id="formError"></div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let legalEntitiesMetaData = [];
        let contractingUnitsMetaData = [];
        let leadDataArr = []; // already filled lead form data


        // Show dialog 
        document.getElementById('validateLeadDialog').style.display = 'flex';

        // data loading for all the six fields
        async function fetchOptions(endpoint, selectedValue) {

            // Creating options for dropdown list of legal entity
            if (endpoint === 'legalEntities') {
                // Fetch legal entities from localStorage
                try {
                    legalEntitiesMetaData = JSON.parse(localStorage.getItem("legalEntityMetaData")) || [];
                } catch (e) {
                    legalEntitiesMetaData = [];
                }
                // Map to dropdown options: value = id, label = company code + name
                const options = legalEntitiesMetaData.map(item => ({
                    value: item.cdm_companyid,
                    label: (item.cdm_companycode ? item.cdm_companycode : "")
                }));
                return Promise.resolve(options);
            }

            if (endpoint === 'contractingUnits') {
                let contractingUnitsMetaData = [];
                try {
                    contractingUnitsMetaData = JSON.parse(localStorage.getItem("contractingUnitMetaData")) || [];
                } catch (e) {
                    contractingUnitsMetaData = [];
                }
                // Include companyId and companyName (formatted) for filtering
                const options = contractingUnitsMetaData.map(item => ({
                    value: item.msdyn_organizationalunitid,
                    label: item.msdyn_name || "",
                    // Use OData lookup convention from FetchXML result
                    companyId: ((item._tcg_company_value || item.tcg_company || "") + "").replace(/[{}]/g, "").toLowerCase(),
                    companyName: item["_tcg_company_value@OData.Community.Display.V1.FormattedValue"] || ""
                }));
                return Promise.resolve(options);
            }

            // creating an options of which is already selected in lead
            // creating options for Customer Group Id
            if (endpoint === 'customerGroups') {
                // Map to dropdown options: value = id, label = name
                // const options = [{
                //     value: selectedValue,
                //     label: selectedValue
                // }];

                // Respect existing-account behavior: keep current value only
                let isExistingAccount = false;
                try {
                    const leadDataLocal = JSON.parse(localStorage.getItem("leadRecordData")) || [];
                    isExistingAccount = !!(leadDataLocal[0] && leadDataLocal[0].existingAccount);
                } catch (e) { isExistingAccount = false; }

                if (isExistingAccount) {
                    const options = [{ value: selectedValue, label: selectedValue }];
                    return Promise.resolve(options);
                }

                // For new account: pull metadata and prepare full list (filtered later by LE)
                let customerGroupMeta = [];
                try {
                    const raw = JSON.parse(localStorage.getItem("customerGroupIdMetaData")) || {};
                    const entities = raw.entities || raw || [];
                    customerGroupMeta = entities.map(item => ({
                        groupId: item.msdyn_groupid || "",
                        companyLabel: item["_msdyn_company_value@OData.Community.Display.V1.FormattedValue"] || ""
                    }));
                } catch (e) { customerGroupMeta = []; }

                const options = customerGroupMeta
                    .filter(x => (x.groupId || "").trim() !== "")
                    .map(x => ({ value: x.groupId, label: x.groupId }))
                    .reduce((acc, cur) => {
                        if (!acc.some(o => o.label === cur.label)) acc.push(cur);
                        return acc;
                    }, []);
                return Promise.resolve(options);
            }

            // creating an options for Account Type which is already selected in lead
            if (endpoint === 'accountTypes') {
                // Map to dropdown options: value = id, label = name
                let accountTypeMetaData = [];
                try {
                    accountTypeMetaData = JSON.parse(localStorage.getItem("accountTypeMetaData")) || [];
                    console.log("Account Type Meta Data in HTML :: ", accountTypeMetaData);
                } catch (e) {
                    accountTypeMetaData = [];
                }
                const options = accountTypeMetaData.map(item => ({
                    value: item.value || item.Value,
                    label: item.text || item.Label
                }));
                // const options = [{
                //     value: selectedValue,
                //     label: selectedValue
                // }];
                return Promise.resolve(options);
            }
            
            // creating an options for Market Segment
            if (endpoint === 'marketSegments') {
                // Fetch market segment options from local storage
                let marketSegmentsMetaData = [];
                try {
                    marketSegmentsMetaData = JSON.parse(localStorage.getItem("marketSegmentMetaData")) || [];
                    console.log("Market Segments Meta Data in HTML :: ", marketSegmentsMetaData);
                } catch (e) {
                    marketSegmentsMetaData = [];
                }
                // Map to dropdown options: value = id, label = name
                const options = marketSegmentsMetaData.map(item => ({
                    value: item.value || item.Value,
                    label: item.text || item.Label
                }));
                return Promise.resolve(options);
            }

            // Creating an options for Industry
            if (endpoint === 'industries') {
                // Fetch industry options from local storage
                let industriesMetaData = [];
                try {
                    industriesMetaData = JSON.parse(localStorage.getItem("IndustryMetaData")) || [];
                    console.log("Industry Meta Data in HTML :: ", industriesMetaData);
                } catch (e) {
                    industriesMetaData = [];
                }
                // Map to dropdown options: value = id, label = name
                const options = industriesMetaData.map(item => ({
                    value: item.value || item.Value,
                    label: item.text || item.Label
                }));
                return Promise.resolve(options);
            }

        }

        // Global default account name for initial preselection
        let defaultAccountName = "";

        // Get WebApi from host
        function getWebApi() {
            return (window.Xrm && window.Xrm.WebApi) ||
                (window.parent && window.parent.Xrm && window.parent.Xrm.WebApi) ||
                (window.top && window.top.Xrm && window.top.Xrm.WebApi) ||
                null;
        }

        // Resolve cdm_company by label (code or name)
        async function resolveCdmCompanyByLabel(label) {
            const webApi = getWebApi();
            if (!webApi || !label) return null;
            const esc = label.replace(/'/g, "''");
            const tries = [
                `?$select=cdm_companyid,cdm_name,cdm_companycode&$top=1&$filter=${encodeURIComponent(`cdm_companycode eq '${esc}'`)}`,
                `?$select=cdm_companyid,cdm_name,cdm_companycode&$top=1&$filter=${encodeURIComponent(`cdm_name eq '${esc}'`)}`
            ];
            for (const q of tries) {
                try {
                    const res = await webApi.retrieveMultipleRecords("cdm_company", q);
                    if (res.entities && res.entities.length) return res.entities[0];
                } catch (e) { /* continue */ }
            }
            return null;
        }

        const customerGrpId = "";
        // Fetch accounts filtered by status and legal entity
        async function fetchAccountsFiltered(statusValue, legalEntityLabel) {
            const webApi = getWebApi();
            if (!webApi) return [];

            const statusCode = (statusValue === 'inactive') ? 1 : 0; // Active=0, Inactive=1
            let companyId = null;
            try {
                const comp = await resolveCdmCompanyByLabel(legalEntityLabel);
                companyId = comp && comp.cdm_companyid ? (comp.cdm_companyid + '').replace(/[{}]/g, '') : null;
            } catch (e) { companyId = null; }

            const filters = [`statecode eq ${statusCode}`];
            if (companyId) {
                // Lookup filter by raw guid on _msdyn_company_value
                filters.push(`_msdyn_company_value eq ${companyId}`);
            }

            const filter = filters.join(' and ');
            // const query = `?$select=accountid,name,accountnumber&$orderby=name asc&$top=100&$filter=${encodeURIComponent(filter)}`; // for top 100 records only
            const query = `?$select=accountid,_msdyn_customergroupid_value, name,accountnumber&$orderby=name asc&$filter=${encodeURIComponent(filter)}`;


            try {
                const res = await webApi.retrieveMultipleRecords("account", query);
                console.log("Account res :: ", res)
                const list = (res.entities || []).map(a => ({
                    id: (a.accountid + '').replace(/[{}]/g, ''),
                    name: a.name || '',
                    number: a.accountnumber || ''
                }));
                return list;
            } catch (e) {
                return [];
            }
        }

        function populateAccountSelect(accounts, selectedName, isExistingAccount) {
            console.log("Account Name for New Account :: ", selectedName);
            const select = document.getElementById('account');
            if (!select) return;
            select.innerHTML = '<option value="">Select...</option>';
            accounts?.forEach(a => {
                const opt = document.createElement('option');
                // opt.value = a.name || '';
                // opt.textContent = a.name || '';
                const accountName = a.name || '';
                const accountNumber = a.number || '';

                opt.value = accountName;
                // Show account number as secondary in the visible text (styling inside option is limited)
                opt.textContent = accountNumber ? `${accountName} (${accountNumber})` : accountName;

                if (selectedName && selectedName === a.name) {
                    opt.selected = true;
                }

                // preserve id as data attribute in case needed later
                opt.setAttribute('data-id', a.id || '');
                if (accountNumber) opt.setAttribute('data-account-number', accountNumber);
                opt.title = accountNumber ? `${accountName} (${accountNumber})` : accountName;
                select.appendChild(opt);
            });

            // If leadData.existingAccount === false, just add selectedName as a new option and select it
            try {
                if (selectedName && !isExistingAccount) {
                    const opt = document.createElement('option');
                    opt.value = selectedName;
                    opt.textContent = selectedName;
                    opt.selected = true;
                    console.log("opt.value :: ", opt.value)
                    opt.setAttribute('data-id', '');
                    select.appendChild(opt);
                } else {
                    console.log("Else mein jaa rha hai")
                }
            } catch (e) {
                console.error("Error populating account for new account scenario:", e);
            }
        }

        async function updateAccountOptions(prefillName, isExistingAccount) {
            const leSelect = document.getElementById('legalEntity');
            const statusChecked = document.querySelector('input[name="accountStatus"]:checked');
            const leLabel = leSelect ? (leSelect.options[leSelect.selectedIndex]?.text || leSelect.value || '') : '';
            const statusVal = statusChecked ? statusChecked.value : 'active';
            let accounts = [];
            console.log("Existing Account :: ", isExistingAccount)
            if (isExistingAccount) {
                accounts = await fetchAccountsFiltered(statusVal, leLabel);
                console.log("Inside If conditions")
            }
            console.log("Accounts :: ", accounts)

            populateAccountSelect(accounts, prefillName || defaultAccountName, isExistingAccount);
            // Prevent future forced preselects after first population
            defaultAccountName = "";

            // Update hyperlink based on selection when existing account
			try {
				updateAccountLinkUI(isExistingAccount);
			} catch (e) { }
        }

        // Helper
        function normalizeGuid(g) { return (g || "").replace(/[{}]/g, "").toLowerCase(); }

        // setting up the field both autopopulate & manually
        async function loadDialogOptions() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('leadForm').style.display = 'none';

            // Get lead data from localStorage

            try {
                leadDataArr = JSON.parse(localStorage.getItem("leadRecordData")) || [];
            } catch (e) {
                leadDataArr = [];
            }
            // Use first record if available
            const leadData = leadDataArr.length > 0 ? leadDataArr[0] : {};
            console.log("HTML - Lead Record Data::", leadData);
            defaultAccountName = leadData.accountName || "";
            
            // Update dialog title with lead full name
            try {
                const titleEl = document.querySelector('.dialog-title span');
                if (titleEl) {
                    const fullName = (leadData.leadFullName || '').trim();
                    titleEl.textContent = fullName ? `Validate Lead : ${fullName}` : 'Validate Lead';
                }
            } catch (e) { }

            // Fetch all options
            var [legalEntities, contractingUnits, marketSegments, industries, customerGroups, accountTypes] = await Promise.all([
                fetchOptions('legalEntities', leadData.legalEntity || ""),
                fetchOptions('contractingUnits', leadData.contractingUnit || ""),
                fetchOptions('marketSegments', leadData.marketSegment || ""),
                fetchOptions('industries', leadData.industry || ""),
                fetchOptions('customerGroups', leadData.customerGroupId),
                fetchOptions('accountTypes', leadData.accountType)
            ]);




            // Populate selects
            function populateSelect(id, options, selectedValue) {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">Select...</option>';
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.label;
                    option.textContent = opt.label;

                    if (selectedValue && selectedValue === opt.label) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }


            // Populate selects
            populateSelect('legalEntity', legalEntities, leadData.legalEntity || "");
            populateSelect('marketSegment', marketSegments, leadData.marketSegment || "");
            populateSelect('industry', industries, leadData.industry || "");
            populateSelect('customerGroupId', customerGroups, leadData.customerGroupId || "");
            populateSelect('accountType', accountTypes, leadData.accountType || "");

            // Contracting Unit: filtered on initial load
            const leSelect = document.getElementById('legalEntity');
            const accSelect = document.getElementById('account');

            // Helper
            const norm = s => (s || "").replace(/[{}]/g, "").toLowerCase();

            // Initial filter (preselected LE from lead/localStorage)
            let selectedLEId = norm(leSelect.value);
            let selectedLELabel = leSelect.options[leSelect.selectedIndex]?.text || "";

            function filterCUByLE(cuOpts, leId, leLabel) {
                if (leId) {
                    const byId = cuOpts.filter(cu => cu.companyId === leId);
                    if (byId.length) return byId;
                }
                if (leLabel) {
                    const byName = cuOpts.filter(cu => (cu.companyName || "").trim() === (leLabel || "").trim());
                    if (byName.length) return byName;
                }
                return cuOpts; // show all when no LE or no match
            }

            // Customer Group filtering based on Legal Entity (new account only)
            function getCustomerGroupOptionsForLE(leLabel) {
                // when LE not selected, return all group ids
                let meta = [];
                try {
                    const raw = JSON.parse(localStorage.getItem("customerGroupIdMetaData")) || {};
                    const entities = raw.entities || raw || [];
                    meta = entities.map(item => ({
                        groupId: item.msdyn_groupid || "",
                        companyLabel: item["_msdyn_company_value@OData.Community.Display.V1.FormattedValue"] || ""
                    }));
                } catch (e) { meta = []; }

                const filtered = (leLabel && leLabel.trim()) ? meta.filter(x => (x.companyLabel || "").trim() === leLabel.trim()) : meta;
                // unique by groupId
                const options = filtered
                    .filter(x => (x.groupId || "").trim() !== "")
                    .map(x => ({ value: x.groupId, label: x.groupId }))
                    .reduce((acc, cur) => { if (!acc.some(o => o.label === cur.label)) acc.push(cur); return acc; }, []);
                return options;
            }

            let contractingUnitsFiltered = filterCUByLE(contractingUnits, selectedLEId, selectedLELabel);
            populateSelect('contractingUnit', contractingUnitsFiltered, leadData.contractingUnit || "");

            // For new account, filter initial Customer Group options by current LE (or show all if none)
            if (!leadData.existingAccount) {
                const cgInit = getCustomerGroupOptionsForLE(selectedLELabel);
                populateSelect('customerGroupId', cgInit, leadData.customerGroupId || "");
            }

            // Re-filter when user changes Legal Entity
            leSelect?.addEventListener('change', function () {
                // console.log("Legal Entity changed:: ", this.value);
                const leIdNow = norm(this.value);   // right now it stores the legal entity
                const leLabelNow = this.options[this.selectedIndex]?.text || "";    // right now stores the legal entity
                
                const cuFiltered = filterCUByLE(contractingUnits, leIdNow, leLabelNow);
                populateSelect('contractingUnit', cuFiltered, "");
                // Refresh accounts when LE changes
                // updateAccountOptions("", leadData.existingAccount);
                if (leadData.existingAccount) {
                    updateAccountOptions("", leadData.existingAccount);
                }


                // For new account, re-filter and CLEAR Customer Group on LE change
                if (!leadData.existingAccount) {
                    const cgOpts = getCustomerGroupOptionsForLE(leLabelNow);
                    populateSelect('customerGroupId', cgOpts, ""); // clear selection
                }
            });

            

            // ACCOUNT hyperlink + auto CG for existing account
            function updateAccountLinkUI(isExistingAccount) {
                const linkContainer = document.getElementById('accountLinkContainer');
                const link = document.getElementById('accountLink');
                const sel = document.getElementById('account');
                if (!linkContainer || !link || !sel) return;

                const opt = sel.options[sel.selectedIndex];
                const accountId = opt ? (opt.getAttribute('data-id') || '').replace(/[{}]/g, '') : '';
                const accountName = opt ? (opt.textContent || '').trim() : '';

                if (!isExistingAccount || !accountId) {
                    linkContainer.style.display = 'none';
                    return;
                }
                linkContainer.style.display = 'block';
                link.textContent = accountName ? `Open ${accountName}` : 'Open Account';
                try {
                    const X = (window.Xrm || window.parent?.Xrm || window.top?.Xrm);
                    const base = (X && X.Utility && X.Utility.getGlobalContext) ? X.Utility.getGlobalContext().getClientUrl() : window.location.origin;
                    const url = `${base}/main.aspx?etn=account&id=%7B${accountId}%7D&pagetype=entityrecord`;
                    link.setAttribute('href', url);
                    link.setAttribute('target', '_blank');
                    link.setAttribute('rel', 'noopener');
                } catch (err) { /* noop */ }
               
            }

            // fetch & set customer grp id & account type for account  
            async function fetchAndSetCustomerGroupForAccount(accountId) {
                try {
                    const webApi = getWebApi();
                    if (!webApi || !accountId) return;
                    const result = await webApi.retrieveMultipleRecords('account', `?$select=_msdyn_customergroupid_value,tcg_accounttype, name,accountnumber &$filter=accountid eq ${accountId}`);

                    const res = (result.entities && result.entities.length) ? result.entities[0] : null;
                    
                    const cg = res?.["_msdyn_customergroupid_value@OData.Community.Display.V1.FormattedValue"] || '';
                    const at = res?.["tcg_accounttype@OData.Community.Display.V1.FormattedValue"] || '';

                    const cgSelect = document.getElementById('customerGroupId');
                    const atSelect = document.getElementById('accountType');

                    if (!cgSelect) return;
                    if(!atSelect) return;

                    // Replace options with this single value for existing account
                    cgSelect.innerHTML = '<option value="">Select...</option>';
                    atSelect.innerHTML = '<option value="">Select...</option>';

                    // set customer grp id based on account change
                    if (cg) {
                        const o = document.createElement('option');
                        o.value = cg;
                        o.textContent = cg;
                        o.selected = true;
                        cgSelect.appendChild(o);
                    }

                    // set account type based on account change
                    if(at){
                        const o = document.createElement('option');
                        o.value = at;
                        o.textContent = at;
                        o.selected = true;
                        atSelect.appendChild(o);
                        console.log("atSelect:: ", atSelect)
                    }
                } catch (e) { /* ignore */ }
            }

            // On account change: update link and auto-populate CG for existing account
            const accountSelectEl = document.getElementById('account');
            if (accountSelectEl) {
                accountSelectEl.addEventListener('change', function () {
                    updateAccountLinkUI(leadData.existingAccount);
                    if (leadData.existingAccount) {
                        const opt = this.options[this.selectedIndex];
                        console.log("opt:: ", opt)
                        const accountId = opt ? (opt.getAttribute('data-id') || '').replace(/[{}]/g, '') : '';
                        console.log("accountId :: ", accountId);
                        fetchAndSetCustomerGroupForAccount(accountId);
                    }
                });
            }

            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('leadForm').style.display = 'block';

            // Prefill account fields from lead data if available
            try {
                if (leadData.accountName) {
                    defaultAccountName = leadData.accountName;
                }
                const activeRadio = document.getElementById('accountStatusActive');
                const inactiveRadio = document.getElementById('accountStatusInactive');
                // Prefill account status radio buttons
                if (activeRadio && leadData?.accountStatus === "Active") {
                    activeRadio.checked = true;
                } else if (inactiveRadio && leadData?.accountStatus === "Inactive") {
                    inactiveRadio.checked = true;
                }
                else if (leadData.accountStatus === false && inactiveRadio) {  // in case of new account
                    inactiveRadio.checked = true;
                    activeRadio.disabled = true;
                    inactiveRadio.disabled = true;
                }
                // Initial accounts load based on defaults
                console.log("defaultAccountName :: ", defaultAccountName);
                await updateAccountOptions(defaultAccountName, leadData.existingAccount);

                // After initial load, if existing account, set link and auto CG & Account type from selected account
                if (leadData.existingAccount) {
                    setTimeout(() => {
                        try {
                            const sel = document.getElementById('account');
                            const opt = sel ? sel.options[sel.selectedIndex] : null;
                            const accountId = opt ? (opt.getAttribute('data-id') || '').replace(/[{}]/g, '') : '';
                            if (accountId) {
                                // Fetch and set customer group & Account Type for the selected account
                                fetchAndSetCustomerGroupForAccount(accountId);
                            }
                            // Update account link UI
                            updateAccountLinkUI(true);
                        } catch (e) { }
                    }, 0);
                }
            } catch (e) {
                console.error("Error pre-filling account fields: ", e);
            }

            // Refresh accounts when status changes
            try {
                const radios = document.querySelectorAll('input[name="accountStatus"]');
                radios.forEach(r => r.addEventListener('change', function () {
                    updateAccountOptions("", leadData.existingAccount);
                }));
            } catch (e) { }
        }

        loadDialogOptions();

        // Parse returnKey passed via pageInput.data
        function getReturnKey() {
            try {
                const params = new URLSearchParams(window.location.search);
                const raw = params.get("data");
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                return parsed && parsed.returnKey ? parsed.returnKey : null;
            } catch (e) { return null; }
        }
        const returnKey = getReturnKey();

        function closeHostDialog(payload) {
            // Prefer current frame
            if (window.Xrm && window.Xrm.Navigation && typeof window.Xrm.Navigation.closeDialog === "function") {
                window.Xrm.Navigation.closeDialog(payload ?? null);
                return;
            }
            // Parent
            if (window.parent && window.parent.Xrm && window.parent.Xrm.Navigation && typeof window.parent.Xrm.Navigation.closeDialog === "function") {
                window.parent.Xrm.Navigation.closeDialog(payload ?? null);
                return;
            }
            // Top
            if (window.top && window.top.Xrm && window.top.Xrm.Navigation && typeof window.top.Xrm.Navigation.closeDialog === "function") {
                window.top.Xrm.Navigation.closeDialog(payload ?? null);
                return;
            }
            // Fallback: close icon (will return null to caller)
            try {
                const btn = window.parent?.document?.querySelector("button[data-id='dialogCloseIconButton']");
                if (btn) btn.click();
            } catch (e) { }
        }

        function closeDialog() {
            closeHostDialog(null);
        }
        function submitForm() {
            // Simple validation
            let valid = true;
            function check(id) {
                const val = document.getElementById(id).value;
                const err = document.getElementById('error' + id.charAt(0).toUpperCase() + id.slice(1));
                if (!val) {
                    err.textContent = 'Required';
                    valid = false;
                } else {
                    err.textContent = '';
                }
            }
            ['legalEntity', 'contractingUnit', 'marketSegment', 'industry', 'customerGroupId', 'accountType'].forEach(check);

            // Validate Account Status radio
            const statusErr = document.getElementById('errorAccountStatus');
            const statusVal = (document.querySelector('input[name="accountStatus"]:checked') || {}).value;
            if (!statusVal) {
                statusErr.textContent = 'Required';
                valid = false;
            } else {
                statusErr.textContent = '';
            }

            // Validate Account dropdown
            const accountE1 = document.getElementById('account');
            const accountErr = document.getElementById('errorAccount');
            if (!accountE1.value) {
                accountErr.textContent = 'Required';
                valid = false;
            } else {
                accountErr.textContent = '';
            }

            if (!valid) {
                document.getElementById('formError').textContent = 'Please fill all required fields.';
                return;
            } else {
                document.getElementById('formError').textContent = '';
            }

            // Collect data
            const accountSelect = document.getElementById('account');
            const selectedAccountOption = accountSelect ? accountSelect.options[accountSelect.selectedIndex] : null;
            const selectedAccountId = selectedAccountOption ? (selectedAccountOption.getAttribute('data-id') || '') : '';

            const data = {
                legalEntity: document.getElementById('legalEntity').value,
                contractingUnit: document.getElementById('contractingUnit').value,
                marketSegment: document.getElementById('marketSegment').value,
                industry: document.getElementById('industry').value,
                customerGroupId: document.getElementById('customerGroupId').value,
                accountType: document.getElementById('accountType').value,
                account: document.getElementById('account').value,
                accountId: selectedAccountId,
                accountStatus: (document.querySelector('input[name="accountStatus"]:checked') || {}).value
            };

            // Fallback channel for parent to pick up if returnValue ends up null
            if (returnKey) {
                try { sessionStorage.setItem(returnKey, JSON.stringify(data)); } catch (e) { }
            }

            closeHostDialog(data);

        }
    </script>

</body>

</html>
